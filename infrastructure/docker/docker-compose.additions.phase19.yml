services:
  limits:
    build: ../../src/Control/Atlas.Limits
    environment:
      - ASPNETCORE_URLS=http://+:5901
      - REDIS=redis:6379
    ports: ["5901:5901"]
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:5901/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 5s

  canary:
    build: ../../src/Synthetic/Atlas.Canary
    environment:
      - PAYMENTS_BASE=http://paymentsapi:5191
      - TENANT=tnt_demo
      - CANARY_MS=15000
    restart: unless-stopped

  prometheus:
    image: prom/prometheus:v2.55.0
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ./rules:/etc/prometheus/rules:ro
    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
      - "--storage.tsdb.path=/prometheus"
      - "--web.console.libraries=/etc/prometheus/console_libraries"
      - "--web.console.templates=/etc/prometheus/consoles"
      - "--storage.tsdb.retention.time=200h"
      - "--web.enable-lifecycle"
    ports: ["9090:9090"]
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:9090/-/healthy"]
      interval: 30s
      timeout: 10s
      retries: 3

  alertmanager:
    image: prom/alertmanager:v0.27.0
    volumes:
      - ./alertmanager/alertmanager.yml:/etc/alertmanager/alertmanager.yml:ro
    command:
      - "--config.file=/etc/alertmanager/alertmanager.yml"
      - "--storage.path=/alertmanager"
      - "--web.external-url=http://localhost:9093"
    ports: ["9093:9093"]
    depends_on: [prometheus]
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:9093/-/healthy"]
      interval: 30s
      timeout: 10s
      retries: 3

  grafana:
    image: grafana/grafana:11.2.0
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - GF_INSTALL_PLUGINS=grafana-piechart-panel
      - GF_DASHBOARDS_DEFAULT_HOME_DASHBOARD_PATH=/var/lib/grafana/dashboards/limits-overview.json
    ports: ["3000:3000"]
    depends_on: [prometheus]
    volumes:
      - ./grafana/dashboards:/var/lib/grafana/dashboards:ro
      - ./grafana/provisioning:/etc/grafana/provisioning:ro
      - grafana-storage:/var/lib/grafana
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3

volumes:
  grafana-storage:
    driver: local

# Mount points expected:
#   infrastructure/observability/prometheus/rules/atlas-slos.yml -> prometheus /etc/prometheus/rules
#   infrastructure/observability/alertmanager/alertmanager.yml -> alertmanager /etc/alertmanager/alertmanager.yml
#   infrastructure/observability/grafana/dashboards/limits-overview.json -> grafana /var/lib/grafana/dashboards
